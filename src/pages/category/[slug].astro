---
import Base from '../../layouts/Base.astro';
import { getCategoryBySlug, getRecallsByCategory } from '../../lib/db';
import { agencyLabel, formatShortDate, truncate, severityBg, severityLabel } from '../../lib/format';

const { slug } = Astro.params;
const env = Astro.locals.runtime.env;
const category = await getCategoryBySlug(env, slug!);
if (!category) return Astro.redirect('/404');

const page = parseInt(Astro.url.searchParams.get('page') || '1');
const result = await getRecallsByCategory(env, category.category_id, page, 50);
const totalPages = Math.ceil(result.total / result.perPage);

const breadcrumbs = [
  { name: 'Home', url: '/' },
  { name: 'Categories', url: '/category' },
  { name: category.category_name, url: `/category/${category.slug}` },
];
---

<Base
  title={`${category.category_name} Recalls (${result.total.toLocaleString()}) | PlainRecalls`}
  description={category.description || `Browse ${result.total.toLocaleString()} ${category.category_name.toLowerCase()} product recalls.`}
  breadcrumbs={breadcrumbs}
>
  <section class="section">
    <div class="mx-auto max-w-5xl px-4">
      <h1 class="text-3xl font-bold text-gray-900 dark:text-white">{category.category_name} Recalls</h1>
      {category.description && <p class="mt-2 text-gray-600 dark:text-gray-400">{category.description}</p>}
      <p class="mt-1 text-sm text-gray-500">{result.total.toLocaleString()} recalls &middot; Page {page} of {totalPages}</p>

      <div class="mt-8 space-y-3">
        {result.recalls.map(recall => (
          <a href={`/recall/${recall.slug}`} class="card block hover:shadow-md transition-shadow">
            <div class="flex items-center gap-2">
              <span class="text-xs font-medium text-gray-500">{agencyLabel(recall.agency)}</span>
              <span class:list={['badge', severityBg(recall.severity)]}>{severityLabel(recall.severity)}</span>
              <span class="text-xs text-gray-500">{formatShortDate(recall.date_reported)}</span>
            </div>
            <h2 class="mt-1 font-semibold text-gray-900 dark:text-white">{truncate(recall.title, 150)}</h2>
            {recall.recalling_firm && <p class="mt-0.5 text-sm text-gray-500">{recall.recalling_firm}</p>}
          </a>
        ))}
      </div>

      {totalPages > 1 && (
        <nav class="pagination mt-8 justify-center">
          {page > 1 && <a href={`/category/${slug}?page=${page-1}`}>&laquo; Prev</a>}
          {Array.from({length: Math.min(totalPages, 10)}, (_, i) => {
            const p = i + 1;
            return p === page
              ? <span class="active">{p}</span>
              : <a href={`/category/${slug}?page=${p}`}>{p}</a>;
          })}
          {totalPages > 10 && <span>...</span>}
          {page < totalPages && <a href={`/category/${slug}?page=${page+1}`}>Next &raquo;</a>}
        </nav>
      )}

      <!-- Cross-Portal Links -->
      <div class="mt-10 pt-6 border-t border-gray-200 dark:border-gray-800">
        <h3 class="text-sm font-semibold uppercase tracking-wider mb-3 text-gray-900 dark:text-white">Explore Related Data</h3>
        <div class="flex flex-wrap gap-2">
          <a href="https://plaincars.com" class="text-sm px-3 py-1.5 rounded-lg border border-gray-300 dark:border-gray-700 hover:border-blue-500 dark:hover:border-blue-400 transition-colors text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400" target="_blank" rel="noopener">Vehicle Safety →</a>
          <a href="https://plainmeds.com" class="text-sm px-3 py-1.5 rounded-lg border border-gray-300 dark:border-gray-700 hover:border-blue-500 dark:hover:border-blue-400 transition-colors text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400" target="_blank" rel="noopener">Drug Information →</a>
        </div>
      </div>
    </div>
  </section>
</Base>
