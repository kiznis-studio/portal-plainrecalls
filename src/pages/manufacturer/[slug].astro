---
import Base from '../../layouts/Base.astro';
import { getManufacturerBySlug, getRecallsByManufacturer } from '../../lib/db';
import { agencyLabel, formatShortDate, truncate, severityBg, severityLabel } from '../../lib/format';

const { slug } = Astro.params;
const env = Astro.locals.runtime.env;
const manufacturer = await getManufacturerBySlug(env, slug!);
if (!manufacturer) return Astro.redirect('/404');

const page = parseInt(Astro.url.searchParams.get('page') || '1');
const result = await getRecallsByManufacturer(env, manufacturer.manufacturer_id, page, 50);
const totalPages = Math.ceil(result.total / result.perPage);

const breadcrumbs = [
  { name: 'Home', url: '/' },
  { name: 'Manufacturers', url: '/manufacturer' },
  { name: manufacturer.name, url: `/manufacturer/${manufacturer.slug}` },
];
---

<Base
  title={`${manufacturer.name} — ${result.total} Recalls | PlainRecalls`}
  description={`${manufacturer.name} has ${result.total} product recalls on record. View the full recall history from FDA, CPSC, and NHTSA.`}
  breadcrumbs={breadcrumbs}
>
  <section class="section">
    <div class="mx-auto max-w-5xl px-4">
      <h1 class="text-3xl font-bold text-gray-900 dark:text-white">{manufacturer.name}</h1>
      <p class="mt-2 text-gray-600 dark:text-gray-400">
        {result.total.toLocaleString()} recalls on record
        {manufacturer.latest_recall_date && ` · Latest: ${formatShortDate(manufacturer.latest_recall_date)}`}
      </p>

      <div class="mt-8 space-y-3">
        {result.recalls.map(recall => (
          <a href={`/recall/${recall.slug}`} class="card block hover:shadow-md transition-shadow">
            <div class="flex items-center gap-2">
              <span class="text-xs font-medium text-gray-500">{agencyLabel(recall.agency)}</span>
              <span class:list={['badge', severityBg(recall.severity)]}>{severityLabel(recall.severity)}</span>
              <span class="text-xs text-gray-500">{formatShortDate(recall.date_reported)}</span>
            </div>
            <h2 class="mt-1 font-semibold text-gray-900 dark:text-white">{truncate(recall.title, 150)}</h2>
          </a>
        ))}
      </div>

      {totalPages > 1 && (
        <nav class="pagination mt-8 justify-center">
          {page > 1 && <a href={`/manufacturer/${slug}?page=${page-1}`}>&laquo; Prev</a>}
          {Array.from({length: Math.min(totalPages, 10)}, (_, i) => {
            const p = i + 1;
            return p === page
              ? <span class="active">{p}</span>
              : <a href={`/manufacturer/${slug}?page=${p}`}>{p}</a>;
          })}
          {totalPages > 10 && <span>...</span>}
          {page < totalPages && <a href={`/manufacturer/${slug}?page=${page+1}`}>Next &raquo;</a>}
        </nav>
      )}
    </div>
  </section>
</Base>
